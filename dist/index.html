<!doctype html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"><link href="/css/main.css?v=5.1.0" rel="stylesheet"><meta name="keywords" content="Java,Linux,Mysql,Devs"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0"><meta property="og:type" content="website"><meta property="og:title" content="Jason Lee Essay"><meta property="og:url" content="https://blog.xiaokele.site/index.html"><meta property="og:site_name" content="Jason Lee Essay"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Jason Lee Essay"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",sidebar:{position:"left",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://blog.xiaokele.site/"><meta name="baidu-site-verification" content="EVs7ssiWWK"><meta name="baidu_union_verify" content="c005bc0c69775da3573d1776851b3034"><meta name="google-site-verification" content="DCecPF2mdIv3j__CgHKZ7KkdHn9F-6f4Grk8xYgVklE"><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="alternate" hreflang="zh-Hans" href="https://jasonlee529.github.io"><style>.async-hide{opacity:0!important}</style><script>!function(e,n,t,a,c,s,d,i,m){n.className+=" "+t,s.start=1*new Date,s.end=d=function(){n.className=n.className.replace(RegExp(" ?"+t),"")},(e[a]=e[a]||[]).hide=s,setTimeout(function(){d(),s.end=null},4e3),s.timeout=4e3}(window,document.documentElement,"async-hide","dataLayer",0,{"GTM-P2JZHDB":!0})</script><title>Jason Lee Essay</title><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-1336715083812391",enable_page_level_ads:!0})</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-36831740-1","auto"),ga("send","pageview")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?69f02f078fd202b54793c69f3596a63f 69f02f078fd202b54793c69f3596a63f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><a href="https://github.com/jasonlee529"><img style="position:absolute;top:0;right:0;border:0" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Jason Lee Essay</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Only dead fish go with the flow!</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li></ul></nav><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-1336715083812391",enable_page_level_ads:!0})</script></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/16/Druid配置之Filter配置/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/16/Druid配置之Filter配置/" itemprop="url">Druid配置之Filter配置</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T15:28:00+08:00">2019-04-16</time></span> <span id="/2019/04/16/Druid配置之Filter配置/" class="leancloud_visitors" data-flag-title="Druid配置之Filter配置"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>Druid作为阿里巴巴出品的数据库连接池产品，虽然从坊间传闻hikaricp性能更好，奈何Druid还有监控功能啊，线上的SQL问题统计方便很多，所以必须要了解下Druid的配置</p><p>以下对Druid的依赖管理略过。</p><h4 id="JavaEE版本"><a href="#JavaEE版本" class="headerlink" title="JavaEE版本"></a>JavaEE版本</h4><p>StatViewServlet是一个标准的javax.servlet.http.HttpServlet，需要配置在你web应用中的WEB-INF/web.xml中。<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.alibaba.druid.support.http.StatViewServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/druid/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>根据配置中的url-pattern来访问内置监控页面，如果是上面的配置，内置监控页面的首页是/druid/index.html</p><p>打开上面的配置能够打开页面，相关的sql统计功能还需要打开统计功能：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- Connection Info --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span> <span class="attr">value</span>=<span class="string">"stat,wall,config"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>这样就可以查看到统计功能了。</p><p>一般JavaEE的工程具备一个contextPath，访问路径就是：<a href="http://ip:port/${contextPath}/druid/index.html" target="_blank" rel="noopener">http://ip:port/${contextPath}/druid/index.html</a></p><h4 id="SpringBoot版本"><a href="#SpringBoot版本" class="headerlink" title="SpringBoot版本"></a>SpringBoot版本</h4><p>Spring Boot的配置更简单了，没有web.xml文件了，properties/yml的文件配置就够了。<br></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    druid:</span></span><br><span class="line"><span class="attr">      web-stat-filter:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      stat-view-servlet:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p></p><p>就开启了druid的监控，但是这个有个问题，就是不认<strong>server.serverlet.path</strong>配置项。</p><h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><pre><code>如果用了shiro或者Spring-Security等权限管理，一定要关闭对druid的权限验证，而且也不推荐将druid合并到业务帐号里面。
</code></pre></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/16/mkfs-ext4大容量硬盘与inode/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/16/mkfs-ext4大容量硬盘与inode/" itemprop="url">mkfs.ext4大容量硬盘与inode</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T00:13:00+08:00">2019-04-16</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span> <span id="/2019/04/16/mkfs-ext4大容量硬盘与inode/" class="leancloud_visitors" data-flag-title="mkfs.ext4大容量硬盘与inode"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>有一台机器，已经建立了一个vg，容量是20T，现在准备新建一个lv，作为数据盘根目录，创建此LV过程中出现了各种的问题。</p><p>环境：<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">centos 6.5</span><br><span class="line">e2fsprogs 1.41</span><br><span class="line">磁盘分区：gpt</span><br></pre></td></tr></table></figure><p></p><h3 id="问题1-New-size-too-large-to-be-expressed-in-32-bits"><a href="#问题1-New-size-too-large-to-be-expressed-in-32-bits" class="headerlink" title="问题1:New size too large to be expressed in 32 bits"></a>问题1:New size too large to be expressed in 32 bits</h3><p>ext4分区理论可支持最大1EB，单文件体积16TB。但格式化的过程出现了：<strong>New size too large to be expressed in 32 bits</strong> 这个异常，晚上检索查找到，老版本的e2fsprogs命令存在16T的限制，此BUG修复要在<a href="http://e2fsprogs.sourceforge.net/e2fsprogs-release.html#1.44.5" target="_blank" rel="noopener">E2fsprogs 1.42.12 (August 29, 2014)</a>版本。<br>centos6.5默认是1.41，刚好错过一个版本，因为是甲方远程主机，更新出问题还要出差去修复，没敢做。</p><p>解决方案就是分成了两个10T的lv使用。</p><h4 id="问题2：mkfs-ext4格式化极慢"><a href="#问题2：mkfs-ext4格式化极慢" class="headerlink" title="问题2：mkfs.ext4格式化极慢"></a>问题2：mkfs.ext4格式化极慢</h4><p>以下引自：<a href="https://www.cnblogs.com/xiexj/p/7214502.html" target="_blank" rel="noopener">理解inode</a></p><blockquote><blockquote><p>inode是什么？</p></blockquote></blockquote><blockquote><blockquote><p>理解inode，要从文件储存说起。</p></blockquote></blockquote><blockquote><blockquote><p>文件储存在硬盘上，硬盘的最小存储单位叫做”扇区”（Sector）。每个扇区储存512字节（相当于0.5KB）。</p></blockquote></blockquote><blockquote><blockquote><p>操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个”块”（block）。这种由多个扇区组成的”块”，是文件存取的最小单位。”块”的大小，最常见的是4KB，即连续八个 sector组成一个 block。</p></blockquote></blockquote><blockquote><blockquote><p>文件数据都储存在”块”中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做inode，中文译名为”索引节点”。</p></blockquote></blockquote><blockquote><blockquote><p>每一个文件都有对应的inode，里面包含了与该文件有关的一些信息。</p></blockquote></blockquote><p>inode也需要占用一些存储空间，因为inode是预分配的，所以格式化的时候就已经确定inode的数量了。</p><p>每个inode节点的大小，一般是128字节或256字节。inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。假定在一块1GB的硬盘中，每个inode节点的大小为128字节，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。</p><p>格式化时，每bytes-per-inode(或inode_ratio)字节大小的空间就创建一个inode，在分区大小固定前提下，该值越大，inode个数越少，data block就越多，该值越小，inode个数越多，data block就越少；以默认值16384(即16KiB)为例，如果文件系统上所有文件大小均为16KiB(或平均值)，则data block耗尽的同时inode也将耗尽，二者占文件系统比例处于最理想状态，对于大量小文件的业务，通常将该值调小以增加inode数量；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">        base_features = sparse_super,filetype,resize_inode,dir_index,ext_attr</span><br><span class="line">        default_mntopts = acl,user_xattr</span><br><span class="line">        enable_periodic_fsck = 0</span><br><span class="line">        blocksize = 4096</span><br><span class="line">        inode_size = 256</span><br><span class="line">        inode_ratio = 16384</span><br><span class="line"></span><br><span class="line">[fs_types]</span><br><span class="line">        ext3 = &#123;</span><br><span class="line">                features = has_journal</span><br><span class="line">        &#125;</span><br><span class="line">        ext4 = &#123;</span><br><span class="line">                features = has_journal,extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize,64bit</span><br><span class="line">                inode_size = 256</span><br><span class="line">        &#125;</span><br><span class="line">        big = &#123;</span><br><span class="line">                inode_ratio = 32768</span><br><span class="line">        &#125;</span><br><span class="line">        huge = &#123;</span><br><span class="line">                inode_ratio = 65536</span><br><span class="line">        &#125;</span><br><span class="line">        news = &#123;</span><br><span class="line">                inode_ratio = 4096</span><br><span class="line">        &#125;</span><br><span class="line">        largefile = &#123;</span><br><span class="line">                inode_ratio = 1048576</span><br><span class="line">                blocksize = -1</span><br><span class="line">        &#125;</span><br><span class="line">        largefile4 = &#123;</span><br><span class="line">                inode_ratio = 4194304</span><br><span class="line">                blocksize = -1</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>通过更改inode_ratio的数值来控制inode的数量，用来控制inode的数量及空间，这部分影响格式化的速度。</p><pre><code>如果是和上述相反的大文件存储业务，可以将inode_ratio值调大，以增加data block数量，如使用“-T largefile”选项对应的inode_ratio值为1MiB，在1.8TiB大小的分区创建ext4文件系统时，可增加20~30GiB左右的数据空间。

对于不能准备评估或需求特殊(如海量小文件)的存储业务，可考虑使用ReiserFS、XFS、JFS等，以避免inode耗尽的风险
</code></pre></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/12/Git强制拉取覆盖本地/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/12/Git强制拉取覆盖本地/" itemprop="url">Git强制拉取覆盖本地</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-12T22:17:00+08:00">2019-04-12</time></span> <span id="/2019/04/12/Git强制拉取覆盖本地/" class="leancloud_visitors" data-flag-title="Git强制拉取覆盖本地"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>第一份copy中git删除本地代码，完全重新初始化了代码，提交后，第二个copy使用正常的git pull 无法更新代码，需要进行强制删除操作。<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all  </span><br><span class="line">git reset --hard origin/master </span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><p></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/08/极简Mysql主从配置/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/08/极简Mysql主从配置/" itemprop="url">极简Mysql主从配置</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-08T22:54:00+08:00">2019-04-08</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a></span></span> <span id="/2019/04/08/极简Mysql主从配置/" class="leancloud_visitors" data-flag-title="极简Mysql主从配置"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>Mysql搭建主从其实配置特别简单，核心配置项目就那么几个就够了。</p><h4 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h4><p>Master的配置项目<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=log</span><br><span class="line">binlog-ignore-db=mysql,performance_schema,information_schema</span><br></pre></td></tr></table></figure><p></p><p>其中只有server-id和log-bin这两项是最重要的，当然一般情况下会显示的指定binlog的格式，binlog日志文件的大小等配置。</p><p>Slave的配置：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">replicate-ignore-db=mysql,performance_schema,information_schema</span><br></pre></td></tr></table></figure><p></p><p>其中binlog-ignore-db和replicate-ignore-db分别在master和slave上面配置的不进行同步的数据库，建议两边完全对等，不要出现差异。</p><h4 id="Slave启动同步"><a href="#Slave启动同步" class="headerlink" title="Slave启动同步"></a>Slave启动同步</h4><h5 id="prepare-同步"><a href="#prepare-同步" class="headerlink" title="prepare 同步"></a>prepare 同步</h5><p>开启同步前要么保证主从状态一致，要么保证master的binlog足够slave同步到master一致的状态，不然Slave_sql_ruuning这个标识位会在某些时段变为NO，即便通过<strong>set global sql_slave_skip_counter=1</strong>设置将状态同步到一致，但数据极大可能仍然不是一致的，因为这个操作是跳过了master的部分操作。所以启动同步前一定要保证binlog足够，不然就手工同步一遍master到slave,再开启操作。</p><h5 id="获取master状态"><a href="#获取master状态" class="headerlink" title="获取master状态"></a>获取master状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show master status\G;</span></span><br><span class="line">        File: log.000004</span><br><span class="line">     Position: 154</span><br><span class="line">   Binlog_Do_DB: </span><br><span class="line"> Binlog_Ignore_DB: mysql,performance_schema,information_schema</span><br><span class="line">Executed_Gtid_Set: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>从中提前两个结果 File和Position作为slave启动的脚本。</p><h5 id="启动slave"><a href="#启动slave" class="headerlink" title="启动slave"></a>启动slave</h5><p>将master的file和position填入slave的启动语句中。<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master to </span><br><span class="line">master_host="******",</span><br><span class="line">MASTER_USER = 'root',</span><br><span class="line"> MASTER_PASSWORD = '*****',</span><br><span class="line"> MASTER_LOG_FILE = 'log.000004'  ,</span><br><span class="line">  MASTER_LOG_POS = 154  </span><br><span class="line">;</span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line">show slave status\G;</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: ******</span><br><span class="line">                  Master_User: root</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: log.000004</span><br><span class="line">          Read_Master_Log_Pos: 154</span><br><span class="line">               Relay_Log_File: 8d5dd16836bd-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 355</span><br><span class="line">        Relay_Master_Log_File: log.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Exec_Master_Log_Pos: 154</span><br><span class="line">               Seconds_Behind_Master: 0</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p></p><p>最后一个show slave status是为了确认是不是启动了额。监测指标核心是三个：Relay_Master_Log_File、Exec_Master_Log_Pos、Seconds_Behind_Master。前两个是核心指标，即slave读取到了master的binlog文件和位置，如果这两个参数的结果和master的binlog文件名称和postion一致，即可认为master和slave状态一致。SBM一定意义上表示了slave和master的时延是多少，这个时延是以slave的时间减去master的binlog时间戳，有作弊的可能，因此主要查看前两个参数。</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/04/Connection-is-read-only-Queries-leading-to-data-modification-are-not-allowed/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/04/Connection-is-read-only-Queries-leading-to-data-modification-are-not-allowed/" itemprop="url">Connection is read-only. Queries leading to data modification are not allowed</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-04T17:24:00+08:00">2019-04-04</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a></span></span> <span id="/2019/04/04/Connection-is-read-only-Queries-leading-to-data-modification-are-not-allowed/" class="leancloud_visitors" data-flag-title="Connection is read-only. Queries leading to data modification are not allowed"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul><li>Java 8</li><li>mysql 5.7 1主1从</li><li>mycat 1.6</li><li>druid 1.4</li></ul><h3 id="错误情况"><a href="#错误情况" class="headerlink" title="错误情况"></a>错误情况</h3><p>启动应用，使用jmeter做压力测试，先将所有url都执行一遍，所有的select和insert类型的请求通过，包含update或者delete的请求失败，查看日志，报错信息：Connection is read-only. Queries leading to data modification are not allowed</p><table><thead><tr><th>select</th><th>insert</th><th>update</th><th>delete</th></tr></thead><tbody><tr><td>o</td><td>o</td><td>x</td><td>x</td></tr></tbody></table><h3 id="更改连接池配置"><a href="#更改连接池配置" class="headerlink" title="更改连接池配置"></a>更改连接池配置</h3><p>添加spring-boot的数据库链接池为非只读<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.druid.default-read-only=false</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>select</th><th>insert</th><th>update</th><th>delete</th></tr></thead><tbody><tr><td>o</td><td>o</td><td>x</td><td>x</td></tr></tbody></table><h3 id="添加事务，网上给出最多的方法"><a href="#添加事务，网上给出最多的方法" class="headerlink" title="添加事务，网上给出最多的方法"></a>添加事务，网上给出最多的方法</h3><p>给所有涉及update或者delete的service类添加事务声明<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="meta">@Transactional</span>(readOnly = <span class="keyword">false</span>)</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>select</th><th>insert</th><th>update</th><th>delete</th></tr></thead><tbody><tr><td>o</td><td>o</td><td>x</td><td>x</td></tr></tbody></table><h3 id="切换为直连数据库，意外收获。"><a href="#切换为直连数据库，意外收获。" class="headerlink" title="切换为直连数据库，意外收获。"></a>切换为直连数据库，意外收获。</h3><table><thead><tr><th>select</th><th>insert</th><th>update</th><th>delete</th></tr></thead><tbody><tr><td>o</td><td>o</td><td>o</td><td>o</td></tr></tbody></table><p>没有写入的问题，可以证明是mycat的连接的问题。</p><h3 id="排查mycat的配置信息"><a href="#排查mycat的配置信息" class="headerlink" title="排查mycat的配置信息"></a>排查mycat的配置信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;schema name=&quot;testdb&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot;&gt;</span><br><span class="line">	&lt;table name=&quot;t1&quot; datanode = &quot;dn1&quot; rule=&quot;&quot;/&gt;</span><br><span class="line">   ....</span><br><span class="line">&lt;/schema&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;user name=&quot;root&quot; defaultAccount=&quot;true&quot;&gt;</span><br><span class="line">  &lt;property name=&quot;password&quot;&gt;123456&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;schemas&quot;&gt;testdb&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;readOnly&quot;&gt;false&lt;/property&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>这部分生命信息看上去没有任何问题。</p><h3 id="spring-事务的源代码"><a href="#spring-事务的源代码" class="headerlink" title="spring 事务的源代码"></a>spring 事务的源代码</h3><p>org.springframework.orm.jpa.vendor.HibernateJpaDialect.java beginTransaction方法<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beginTransaction</span><span class="params">(EntityManager entityManager, TransactionDefinition definition)</span><span class="keyword">throws</span> PersistenceException, SQLException, TransactionException </span>&#123;</span><br><span class="line">	Session session = getSession(entityManager);</span><br><span class="line">	<span class="keyword">if</span> (definition.getTimeout() != TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">		session.getTransaction().setTimeout(definition.getTimeout());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">boolean</span> isolationLevelNeeded = (definition.getIsolationLevel() !=TransactionDefinition.ISOLATION_DEFAULT);</span><br><span class="line">	Integer previousIsolationLevel = <span class="keyword">null</span>;</span><br><span class="line">	Connection preparedCon = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (isolationLevelNeeded || definition.isReadOnly()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.prepareConnection) &#123;</span><br><span class="line">			preparedCon = HibernateConnectionHandle.doGetConnection(session);</span><br><span class="line">               <span class="comment">//下面一行的调用起到了关键作用</span></span><br><span class="line">			previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(preparedCon, definition);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (isolationLevelNeeded) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidIsolationLevelException(getClass().getSimpleName() +</span><br><span class="line">					<span class="string">" does not support custom isolation levels since the 'prepareConnection' flag is off."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;		</span><br><span class="line">	entityManager.getTransaction().begin();</span><br><span class="line">	FlushMode previousFlushMode = prepareFlushMode(session, definition.isReadOnly());</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SessionTransactionData(session, previousFlushMode, preparedCon, previousIsolationLevel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>org.springframework.jdbc.datasource.DataSourceUtils.java Line:91</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">prepareConnectionForTransaction</span><span class="params">(Connection con, @Nullable TransactionDefinition definition)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       Assert.notNull(con, <span class="string">"No Connection specified"</span>);</span><br><span class="line">       <span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; definition.isReadOnly()) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                   logger.debug(<span class="string">"Setting JDBC Connection ["</span> + con + <span class="string">"] read-only"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">			<span class="comment">//直接写死为readOnly=true。这个原因需要调查。</span></span><br><span class="line">               con.setReadOnly(<span class="keyword">true</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RuntimeException | SQLException var4) &#123;</span><br><span class="line">               <span class="keyword">for</span>(Object exToCheck = var4; exToCheck != <span class="keyword">null</span>; exToCheck = ((Throwable)exToCheck).getCause()) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (exToCheck.getClass().getSimpleName().contains(<span class="string">"Timeout"</span>)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> var4;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               logger.debug(<span class="string">"Could not set JDBC Connection read-only"</span>, var4);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       Integer previousIsolationLevel = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (definition != <span class="keyword">null</span> &amp;&amp; definition.getIsolationLevel() != -<span class="number">1</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">               logger.debug(<span class="string">"Changing isolation level of JDBC Connection ["</span> + con + <span class="string">"] to"</span> + definition.getIsolationLevel());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> currentIsolation = con.getTransactionIsolation();</span><br><span class="line">           <span class="keyword">if</span> (currentIsolation != definition.getIsolationLevel()) &#123;</span><br><span class="line">               previousIsolationLevel = currentIsolation;</span><br><span class="line">               con.setTransactionIsolation(definition.getIsolationLevel());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> previousIsolationLevel;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这个方法的解释是针对select方法,hibernate会强制设为只读请求，但为啥update方法会来这里，没有找到原因。</p><h3 id="添加参数useLocalSessionState-true"><a href="#添加参数useLocalSessionState-true" class="headerlink" title="添加参数useLocalSessionState=true"></a>添加参数useLocalSessionState=true</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:log4jdbc:mysql://ip:8066/testdb?useUnicode=true&amp;characterEncoding=utf-8&amp;useLocalSessionState=true</span><br></pre></td></tr></table></figure><p>解决了这个问题，关于useLocalSessionState的解释是：<strong><br>默认情况下，我们的连接串信息没有包含useLocalSessionState参数的设置，这个值默认为false。<br>这个值的作用是驱动程序是否使用autocommit，read_only和transaction isolation的内部值(jdbc端的本地值)。<br>如果设置为false，则需要这个判断这三个参数的场景，都需要发语句到远端请求，比如更新语句前，<br>需要发语句select @@session.tx_read_only确认会话是否只读。<br>如果设置为true，则只需要取本地值即可。</strong></p><p>似乎是本地和远程服务器的配置有关，但远程服务器是mycat，莫非mycat的链接不是只读的，但没有找到mycat是只读的配置选项。</p><p>参数可以解决readOnly的问题，但只读链接的产生过程和原因不明。</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/04/03/Mysql主从之Seconds-behind-master/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/04/03/Mysql主从之Seconds-behind-master/" itemprop="url">Mysql主从之Seconds_behind_master</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-03T18:24:00+08:00">2019-04-03</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a></span></span> <span id="/2019/04/03/Mysql主从之Seconds-behind-master/" class="leancloud_visitors" data-flag-title="Mysql主从之Seconds_behind_master"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>Mysql配置主从的监控，主要的监控指标有三个：</p><ul><li>Slave_io_running 负责与主机的io通信</li><li>Slave_sql_running 负责自己的slave mysql进程</li><li>Seconds_behind_master</li></ul><p>其中Seconds_behind_master表示从库与主库的同步时延，即主库的变更需要多久才能同步到从库上。计量单位是timestamp的差值，ms。</p><h4 id="什么时候sbm会是Null"><a href="#什么时候sbm会是Null" class="headerlink" title="什么时候sbm会是Null?"></a>什么时候sbm会是Null?</h4><ul><li>SBM在slave关闭的时为null</li><li>Slave_sql_running不是Yes的时候</li><li>Slave_io_running是no的时候。</li></ul><h4 id="解决sbm是null的问题？"><a href="#解决sbm是null的问题？" class="headerlink" title="解决sbm是null的问题？"></a>解决sbm是null的问题？</h4><p>首先检测问题<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span> ; </span><br><span class="line"></span><br><span class="line">	Slave_io_running  ： yes </span><br><span class="line">	Slave_sql_running :  no</span><br><span class="line">	Seconds_behind_master : null</span><br></pre></td></tr></table></figure><p></p><p>可以通过设置SQL_SLAVE_SKIP_COUNTER来重新开始sql同步。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> SQL_SLAVE_SKIP_COUNTER=<span class="number">1</span>; </span><br><span class="line"><span class="keyword">START</span> <span class="keyword">SLAVE</span>;  </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span> ; </span><br><span class="line"></span><br><span class="line">	Slave_io_running  ： yes </span><br><span class="line">	Slave_sql_running :  yes</span><br><span class="line">	Seconds_behind_master : 7928</span><br></pre></td></tr></table></figure><p></p><p>解决了后发现sbm还是很大。</p><h4 id="sbm不停增长？"><a href="#sbm不停增长？" class="headerlink" title="sbm不停增长？"></a>sbm不停增长？</h4><p>未找到解决方案。</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/03/07/HashMap之put的过程/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/03/07/HashMap之put的过程/" itemprop="url">HashMap之put的过程</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-07T14:27:00+08:00">2019-03-07</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/Map/" itemprop="url" rel="index"><span itemprop="name">Map</span></a></span></span> <span id="/2019/03/07/HashMap之put的过程/" class="leancloud_visitors" data-flag-title="HashMap之put的过程"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>HashMap是Java集合类中，使用比较多的一个集合类。类似request的参数集合、jdbcTemplate的数据库返回啊，这些不定长度的key-value型数据集合，大量的使用到了HashMap。那到底HashMap的api有啥神秘呢？put的过程到底有什么问题呢？</p><h1 id="PUT的实现"><a href="#PUT的实现" class="headerlink" title="PUT的实现"></a>PUT的实现</h1><p>HashMap的Put过程基本可以分为两部分，确认插入位置和更新数据。</p><p>两个过程其实奥秘就是两个基础API：hashCode和equals。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//先计算key的hash值，调用hashCode方法，再进行位移计算。</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//实现放入值的核心过程。</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">       Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">       <span class="comment">//读取当前数组的长度，如果为空，初始化</span></span><br><span class="line">       <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">           n = (tab = resize()).length;</span><br><span class="line">       <span class="comment">// 按照hash读取数组指定位置的元素，为空直接插入</span></span><br><span class="line">       <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">           tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           Node&lt;K,V&gt; e; K k;</span><br><span class="line">           <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">               ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">               e = p;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">               e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                   <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                       <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                           treeifyBin(tab, hash);</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                       ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   p = e;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">               V oldValue = e.value;</span><br><span class="line">               <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                   e.value = value;</span><br><span class="line">               afterNodeAccess(e);</span><br><span class="line">               <span class="keyword">return</span> oldValue;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ++modCount;</span><br><span class="line">       <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">           resize();</span><br><span class="line">       afterNodeInsertion(evict);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/02/26/Thread与Runnable的区别/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/02/26/Thread与Runnable的区别/" itemprop="url">Thread与Runnable的区别</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T14:44:43+08:00">2019-02-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span> <span id="/2019/02/26/Thread与Runnable的区别/" class="leancloud_visitors" data-flag-title="Thread与Runnable的区别"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>Java创建线程有两种方式：</p><ol><li>继承Thread类</li><li>实现Runnable接口，实际Thread类也实现了Runnable接口。</li></ol><p>看下Thread的构造方法列表：</p><ul><li>public Thread()</li><li>public Thread(Runnable target)</li><li>public Thread(Runnable target, String name)</li><li>public Thread(ThreadGroup group, Runnable target, String name)</li><li>public Thread(ThreadGroup group, Runnable target, String name, long stackSize)</li><li>public Thread(ThreadGroup group, String name)</li></ul><p>可以看到Runnable接口的实例是Thread的target。run犯法的实现方式是怎么样子的呢？<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">        target.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这个调用的形式就是通过一个线程实例（创建了一个Thread），调用了另一个线程的run方法。</p><p>所以new Thread()即创建了一个线程。new Thread(Runnable)用一个线程作为容器，共享target的线程变量。为什么呢？</p><p>线程私有变量和线程间共有变量。通过new Thread()的方式创建线程即为线程修改私有变量。new Thread(Runnable)的线程私有变量是target，所以需要共享target的变量。</p><p>当然还有Java的单继承的原因，实际使用中使用Runnable的时候更多。</p><p>还有一点，如果手动调用Runnable.run方法是什么效果呢？不会创建一个新线程，跟普通的同步方法执行一样。</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2019/02/20/2019年的2600x装机记录/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2019/02/20/2019年的2600x装机记录/" itemprop="url">2019年的2600x装机记录</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-20T16:02:46+08:00">2019-02-20</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/工具/" itemprop="url" rel="index"><span itemprop="name">工具</span></a></span></span> <span id="/2019/02/20/2019年的2600x装机记录/" class="leancloud_visitors" data-flag-title="2019年的2600x装机记录"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="购买理由"><a href="#购买理由" class="headerlink" title="购买理由"></a>购买理由</h3><p>程序员一枚，多年办公电脑非公司台式机就是笔记本，最贵的是一台港版Thinkpad T440P。从未搞过一台稍微像点样子的主机犒赏自己，不巧，Thinkpad再一次罢工黑屏，所以趁机….</p><pre><code>总共话费不到7000元。
</code></pre><h3 id="配件展示"><a href="#配件展示" class="headerlink" title="配件展示"></a>配件展示</h3><img src="/2019/02/20/2019年的2600x装机记录/666888758.jpg" title="所有配件图"><p>所有配件图，请忽略帮忙的小王爷所有配件图，请忽略帮忙的小王爷</p><p>配机器的目的以办公为主，游戏需求不高，能运行魔兽争霸就可以，撑死玩个Dota2。所以CPU，这块对线程数要求一定要多。原本很钟情于8700K，6核12线程，无奈价格贵，渠道少；搭配主板也不好组合，B360觉得低，Z370又没有合适的，上Z390又觉得不值当。I5的只有6核6线程。回头看下AMD，核数够了，主频不够高，但也够用，果断AMD了。</p><h3 id="配件详单"><a href="#配件详单" class="headerlink" title="配件详单:"></a>配件详单:</h3><blockquote><p>微星（MSI）B450M MORTAR TITANIUM 迫击炮钛金版主板+AMD 锐龙 5(r5) 2600X CPU 板U套装/主板CPU套装2110元</p></blockquote><p>AMD 2600X 和微星B450M 迫击炮钛金版，便宜好用</p><blockquote><p>威刚(ADATA) XPG-威龙系列 Z1 DDR4 2666频 8GB 台式机内存(红色)389元</p></blockquote><p>2条2666内存，手感不错，马甲摸着很结实，从盒子取出来的时候卡的太紧了</p><blockquote><p>索泰（ZOTAC）GeForce GTX1060 X-GAMING OC吃鸡显卡/游戏电竞台式机独立显卡 6GD5/1569-1784/8008MHz1719元</p></blockquote><blockquote><p>惠普（HP） EX900系列 250G M.2 NVMe SSD固态硬盘299元</p></blockquote><p>主硬盘</p><blockquote><p>东芝(TOSHIBA) 2TB 7200转64M SATA3 台式机硬盘(DT01ACA200)389元</p></blockquote><p>数据盘，容量和速度还好</p><blockquote><p>Tt（Thermaltake）启航者F1 黑色静音版 Mini机箱（支持MATX主板/独立电源仓/支持背线/侧透/钢板0.6mm/U3）179元</p></blockquote><p>比想象的要大，以为M-ATX机箱挺小，这个一点也不小。</p><blockquote><p>乔思伯（JONSBO）12020 12CM机箱风扇（20MM薄型厚度/主板3PIN接口+电源D型口接口/静音）19.9元</p></blockquote><p>乳白色，风量还可以。</p><blockquote><p>戴尔（DELL）P2419H 23.8英寸微边框全面屏旋转升降广视角IPS屏护眼不闪滤蓝光电脑显示器17系列升级款1129元</p></blockquote><p>显示器一直用dell，ips屏幕习惯了。</p><h3 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h3><p>装了Win10,开机不到10-15秒，感觉还可以接受。本人不喜欢各种测试数字，跟使用感受没太大关系，放弃掉。</p><p>安装了Steam,￥65元买了个2K19，挺流畅的。还用上了吃了两年灰的北通 阿修罗TE 2185的手柄，用来打2k19，很顺手。</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.xiaokele.site/2018/11/10/MPVUE和node的ENV的问题/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason Lee"><meta itemprop="description" content><meta itemprop="image" content="/images/1491256964.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason Lee Essay"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Jason Lee Essay" src></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/11/10/MPVUE和node的ENV的问题/" itemprop="url">MPVUE和node的ENV的问题</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-10T16:50:59+08:00">2018-11-10</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mpvue/" itemprop="url" rel="index"><span itemprop="name">mpvue</span></a></span></span> <span id="/2018/11/10/MPVUE和node的ENV的问题/" class="leancloud_visitors" data-flag-title="MPVUE和node的ENV的问题"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>小程序选定了mpvue作为开发框架，搭建开发环境和构建环境。自从用了Travis和Jenkins之后，再也回不到手工构建的时代了。</p><h1 id="目的－自动构建"><a href="#目的－自动构建" class="headerlink" title="目的－自动构建"></a>目的－自动构建</h1><p>web项目中，自从前后台分离的结构形成，就形成了一个要求，前后台的连接URL需要根据部署环境进行切换，线上的URL和测试的URL肯定不同；这点类似于java应用连接数据库的连接切换。<br>后台URL的定义要能够多环境构建是自动构建的目标。</p><h1 id="构建简介"><a href="#构建简介" class="headerlink" title="构建简介"></a>构建简介</h1><p>mpvue的框架基于vue.js构建，利用webpack的扩展工具将vue源码转换为小程序的源码。vue的源码是基于node构建的，理论将node构建生态的env模式也能带入mpvue构建过程。<br>process.env是nodejs提供的官方api。官方定义是：<strong>process.env属性返回一个包含用户环境信息的对象。</strong></p><h1 id="process-env"><a href="#process-env" class="headerlink" title="process.env"></a>process.env</h1><p>process.env.NODE_ENV是默认的全局定义的全局变量.process.env是一个定义对象，可以自定义扩展。<br>比如：</p><pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">process.env = &#123;</span><br><span class="line">    NODE_ENV : <span class="string">'dev'</span>,</span><br><span class="line">    api : <span class="string">'http://example.com'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这样子就实现了自定义的过程，将定义分别放到env.dev.js,env.prod.js,env.test.js即可实现多环境实践。</code></pre><h1 id="mpvue中使用"><a href="#mpvue中使用" class="headerlink" title="mpvue中使用"></a>mpvue中使用</h1><p>mpvue的quickStart提供的构建脚手架，env的定义在config目录中，通过prod.env.js和dev.env.js实现对env的定义。</p><pre><code><figure class="highlight js"><figcaption><span>prod.env.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    NODE_ENV: <span class="string">'"production"'</span>,</span><br><span class="line">    api: <span class="string">'"example.com"'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><p>如何使用呢？<br>因为process是一个node的全局变量，使用Process对象在vue源码中应该是任意使用的。测试下：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="lin